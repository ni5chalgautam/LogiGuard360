<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LogiGuard360 • Hotspot Detector</title>

  <!-- endpoints used on this page:
       POST /hotspotDetector/detect
       POST /hotspotDetector/calibrate -->
  <link rel="stylesheet" href="assets/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="assets/app.js" defer></script>

  <style>
    .lg-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-weight: 950;
      font-size: .9rem;
      white-space: nowrap;
    }
    .lg-pill.high { border-color: rgba(255,0,110,0.40); background: rgba(255,0,110,0.12); }
    .lg-pill.medium { border-color: rgba(0,245,255,0.25); background: rgba(0,245,255,0.08); }
    .lg-pill.low { border-color: rgba(34,197,94,0.25); background: rgba(34,197,94,0.10); }
  </style>
</head>

<body data-page="Hotspot Detector" data-protected="true">
  <main class="lg-page">
    <div class="lg-h1">Hotspot Detector</div>
    <div class="lg-sub">Routes file: <code>hotspotDetectorRoutes.js</code>. Model: <code>HotspotDetector.model.js</code>.</div>

    <div class="lg-grid">
      <section class="lg-card" style="grid-column: span 7;">
        <h3>Detect hotspot (prototype UI)</h3>
        <div class="lg-note">Paste JSON sensor data or event data (whatever your backend expects).</div>

        <label class="lg-k" for="sensor">Sensor / Event JSON</label>
        <textarea class="lg-input" id="sensor" placeholder='{"type":"usb","status":"detected","zone":"Receiving"}'></textarea>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;">
          <button class="lg-btn primary" id="detect"><i class="fa-solid fa-crosshairs"></i> Detect</button>
          <button class="lg-btn" id="calibrate"><i class="fa-solid fa-sliders"></i> Calibrate</button>
        </div>

        <div class="lg-note" id="status" style="margin-top: 10px;"></div>
      </section>

      <section class="lg-card" style="grid-column: span 5;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h3 style="margin:0;">Output</h3>
          <button class="lg-btn" id="toggleOut" type="button" style="display:none;">
            <i class="fa-solid fa-code"></i> View JSON
          </button>
        </div>

        <div class="lg-note" id="outEmpty" style="margin-top:10px;">Run Detect/Calibrate to see results here.</div>

        <!-- formatted table output -->
        <div id="outTable" style="display:none; margin-top:10px;"></div>

        <!-- json output -->
        <pre id="outJson" style="display:none; white-space:pre-wrap; margin:10px 0 0; color: var(--lg-text);"></pre>
      </section>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if(!LG.requireRole(["systemAdministrator","warehouseManager"])) return;

      const sensor = document.getElementById("sensor");
      const status = document.getElementById("status");

      const outEmpty = document.getElementById("outEmpty");
      const outTable = document.getElementById("outTable");
      const outJson = document.getElementById("outJson");
      const toggleOut = document.getElementById("toggleOut");

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function parseJson(){
        try { return JSON.parse(sensor.value || "{}"); }
        catch { throw new Error("Invalid JSON"); }
      }

      function riskClass(r){
        const rr = String(r || "").toLowerCase();
        if(rr === "high") return "high";
        if(rr === "low") return "low";
        return "medium";
      }

      function resetOutput(){
        outEmpty.style.display = "block";
        outTable.style.display = "none";
        outJson.style.display = "none";
        toggleOut.style.display = "none";
        outTable.innerHTML = "";
        outJson.textContent = "";
      }

      function setOutputTable(data){
        outEmpty.style.display = "none";
        outTable.style.display = "block";
        outJson.style.display = "none";

        toggleOut.style.display = "inline-flex";
        toggleOut.dataset.mode = "table";
        toggleOut.dataset.json = JSON.stringify(data, null, 2);
        toggleOut.innerHTML = '<i class="fa-solid fa-code"></i> View JSON';

        // normalize
        let obj = data;
        if(typeof obj === "string"){
          try { obj = JSON.parse(obj); } catch { obj = { message: obj }; }
        }

        const detected = !!obj.detected;
        const risk = obj.riskLevel || "Unknown";
        const score = (typeof obj.score === "number")
          ? `${Math.round(obj.score * 100)}%`
          : (obj.score ?? "—");

        const rows = [
          ["Detected", detected ? "✅ Yes" : "❌ No"],
          ["Risk Level", `<span class="lg-pill ${riskClass(risk)}"><i class="fa-solid fa-triangle-exclamation"></i> ${escapeHtml(risk)}</span>`],
          ["Score", escapeHtml(score)],
          ["Warehouse ID", escapeHtml(obj.warehouseId || "—")],
          ["Zone", escapeHtml(obj.zone || "—")],
          ["Description", escapeHtml(obj.description || "—")],
          ["Created Hotspot ID", escapeHtml(obj.createdHotspotId || "—")]
        ];

        outTable.innerHTML = `
          <table class="lg-table">
            <thead>
              <tr><th style="width:220px;">Field</th><th>Value</th></tr>
            </thead>
            <tbody>
              ${rows.map(([k,v]) => `<tr><td style="font-weight:950;">${k}</td><td>${v}</td></tr>`).join("")}
            </tbody>
          </table>
        `;
      }

      function setOutputJson(data){
        outEmpty.style.display = "none";
        outTable.style.display = "none";
        outJson.style.display = "block";

        outJson.textContent = JSON.stringify(data, null, 2);

        toggleOut.style.display = "inline-flex";
        toggleOut.dataset.mode = "json";
        toggleOut.dataset.json = outJson.textContent;
        toggleOut.innerHTML = '<i class="fa-solid fa-table"></i> View Table';
      }

      function renderOutput(data){
        // Always render table; JSON is toggle
        setOutputTable(data);
      }

      toggleOut.addEventListener("click", () => {
        const mode = toggleOut.dataset.mode;
        const raw = toggleOut.dataset.json || "";
        let data = null;
        try { data = JSON.parse(raw); } catch { data = raw; }

        if(mode === "table") setOutputJson(data);
        else setOutputTable(data);
      });

      document.getElementById("detect").addEventListener("click", async () => {
        status.textContent = "";
        resetOutput();

        try{
          const payload = parseJson();

          const data = await LG.request("/hotspotDetector/detect", {
            method: "POST",
            body: payload
          });

          renderOutput(data);
          status.textContent = "Detection completed.";
        }catch(err){
          status.textContent = err.message + " (check backend route + CORS).";
        }
      });

      document.getElementById("calibrate").addEventListener("click", async () => {
        status.textContent = "";
        resetOutput();

        try{
          const payload = parseJson();

          const data = await LG.request("/hotspotDetector/calibrate", {
            method: "POST",
            body: payload
          });

          renderOutput(data);
          status.textContent = "Calibration completed.";
        }catch(err){
          status.textContent = err.message + " (check backend route + CORS).";
        }
      });
    });
  </script>
</body>
</html>